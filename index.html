<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ Thống Ôn Thi TN THPT 2026</title>
    <!-- Tailwind CSS để làm đẹp giao diện -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome cho các biểu tượng -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* Hiệu ứng chuyển cảnh mượt mà */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .hidden-section { display: none; }
        
        /* Video Player Modal Styles */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.9);
        }
        .video-container {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            height: 0;
            overflow: hidden;
            background: #000;
        }
        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        /* Chặn tương tác chuột lên video để hạn chế click phải/menu youtube */
        .video-blocker {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 85%; /* Chừa lại phần bottom nếu cần, nhưng ở đây ta dùng custom control */
            z-index: 10;
            background: transparent;
            cursor: pointer; /* Thêm con trỏ tay để biết có thể bấm */
        }
    </style>
</head>
<body class="bg-gray-100 font-sans text-gray-800">

    <!-- KHU VỰC THÔNG BÁO (Toast) -->
    <div id="toast-container" class="fixed top-5 right-5 z-50"></div>

    <!-- MODAL XEM VIDEO -->
    <div id="video-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-overlay">
        <div class="bg-white w-full max-w-4xl rounded-lg overflow-hidden shadow-2xl flex flex-col max-h-[90vh]">
            <div class="p-4 bg-gray-900 text-white flex justify-between items-center">
                <h3 id="modal-video-title" class="font-bold text-lg truncate pr-4">Tiêu đề bài học</h3>
                <button onclick="closeVideoModal()" class="text-gray-400 hover:text-white px-2">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="relative bg-black flex-1 flex flex-col justify-center" id="fullscreen-container">
                <div class="video-container">
                    <div id="youtube-player"></div>
                    <!-- Lớp phủ chặn tương tác trực tiếp (để ép dùng nút của mình) -->
                    <div class="video-blocker" onclick="togglePlayPause()" title="Bấm để Phát/Dừng"></div>
                </div>

                <!-- Cảnh báo khi tắt tiếng -->
                <div id="mute-warning" class="hidden absolute inset-0 bg-black bg-opacity-90 z-20 flex flex-col items-center justify-center text-white text-center p-4">
                    <i class="fas fa-volume-mute text-5xl text-red-500 mb-4"></i>
                    <h2 class="text-2xl font-bold mb-2">Vui lòng bật tiếng!</h2>
                    <p>Hệ thống yêu cầu học sinh không tắt tiếng trong quá trình học.</p>
                    <button onclick="unmuteVideo()" class="mt-4 px-6 py-2 bg-blue-600 rounded hover:bg-blue-700 font-bold">
                        Bật tiếng và Tiếp tục
                    </button>
                </div>
            </div>

            <!-- Custom Controls -->
            <div class="bg-gray-800 text-white p-4">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center space-x-4">
                        <button id="btn-play-pause" onclick="togglePlayPause()" class="hover:text-blue-400 w-8">
                            <i class="fas fa-play"></i>
                        </button>
                        <span class="text-sm font-mono" id="time-display">00:00 / 00:00</span>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span class="text-xs text-gray-400 mr-2">Đã xem: <span id="max-watched-display" class="text-green-400">0%</span></span>
                        <button onclick="toggleFullscreen()" class="hover:text-blue-400" title="Phóng to">
                            <i class="fas fa-expand"></i> Zoom
                        </button>
                    </div>
                </div>
                <!-- Progress Bar (Chỉ hiển thị, không cho kéo) -->
                <div class="w-full bg-gray-600 h-2 rounded-full relative cursor-not-allowed">
                    <div id="video-progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    <!-- Marker điểm đã xem xa nhất -->
                    <div id="max-watched-marker" class="absolute top-0 left-0 h-2 bg-green-500 bg-opacity-30 pointer-events-none" style="width: 0%"></div>
                </div>
                <p class="text-xs text-gray-500 mt-2 text-center italic">* Lưu ý: Hệ thống không cho phép tua vượt qua đoạn chưa học.</p>
            </div>
        </div>
    </div>

    <!-- 1. MÀN HÌNH ĐĂNG NHẬP / ĐĂNG KÝ -->
    <div id="auth-view" class="min-h-screen flex items-center justify-center bg-gradient-to-r from-blue-500 to-purple-600 p-4">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-md">
            <h1 class="text-3xl font-bold text-center mb-6 text-blue-800">Ôn Thi THPT 2026</h1>
            
            <div class="flex justify-center mb-6">
                <i class="fas fa-graduation-cap text-6xl text-blue-500"></i>
            </div>

            <div class="space-y-4">
                <input type="email" id="auth-email" placeholder="Email" class="w-full p-3 border rounded focus:outline-none focus:ring-2 focus:ring-blue-400">
                <input type="password" id="auth-pass" placeholder="Mật khẩu" class="w-full p-3 border rounded focus:outline-none focus:ring-2 focus:ring-blue-400">
                
                <button onclick="handleLogin()" class="w-full bg-blue-600 text-white p-3 rounded hover:bg-blue-700 font-bold transition">Đăng Nhập</button>
                <button onclick="handleRegister()" class="w-full bg-gray-200 text-gray-700 p-3 rounded hover:bg-gray-300 font-bold transition">Đăng Ký Tài Khoản Mới</button>
            </div>
            <p class="text-xs text-center text-gray-500 mt-4">Tài khoản đầu tiên đăng ký sẽ là Admin (Quản trị viên).</p>
        </div>
    </div>

    <!-- GIAO DIỆN CHÍNH (Sau khi đăng nhập) -->
    <div id="main-app" class="hidden-section min-h-screen flex flex-col">
        
        <!-- Navbar -->
        <nav class="bg-blue-800 text-white shadow-lg">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                <div class="flex items-center space-x-2 cursor-pointer" onclick="navigateTo('dashboard')">
                    <i class="fas fa-book-open text-xl"></i>
                    <span class="text-xl font-bold hidden md:block">Luyện Thi 2026</span>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="user-display-name" class="font-medium">Xin chào, User</span>
                    <button onclick="handleLogout()" class="bg-red-500 hover:bg-red-600 px-3 py-1 rounded text-sm transition">
                        <i class="fas fa-sign-out-alt"></i> Thoát
                    </button>
                </div>
            </div>
        </nav>

        <div class="flex flex-1 overflow-hidden">
            <!-- Sidebar (Menu bên trái) -->
            <aside class="w-64 bg-white shadow-md hidden md:block flex-col">
                <div class="p-4 border-b">
                    <h3 class="font-bold text-gray-500 uppercase text-xs">Menu Chính</h3>
                </div>
                <nav class="flex-1 p-4 space-y-2">
                    <button onclick="navigateTo('dashboard')" class="w-full text-left px-4 py-2 rounded hover:bg-blue-50 text-blue-700 font-medium">
                        <i class="fas fa-home w-6"></i> Trang Chủ
                    </button>
                    <button onclick="navigateTo('group-chat')" class="w-full text-left px-4 py-2 rounded hover:bg-blue-50 text-gray-600 hover:text-blue-700 transition">
                        <i class="fas fa-users w-6"></i> Nhóm Học Tập
                    </button>
                    
                    <div id="admin-menu-item" class="hidden">
                        <div class="mt-4 mb-2 px-4 text-xs font-bold text-gray-400 uppercase">Quản Trị Viên</div>
                        <button onclick="navigateTo('admin-panel')" class="w-full text-left px-4 py-2 rounded hover:bg-red-50 text-red-600 font-medium">
                            <i class="fas fa-user-shield w-6"></i> Quản Lý Tài Khoản
                        </button>
                    </div>
                </nav>
            </aside>

            <!-- Nội dung chính -->
            <main class="flex-1 p-6 overflow-y-auto bg-gray-50" id="content-area">
                
                <!-- 2. TRANG CHỦ (Chọn Môn & Tiến Độ) -->
                <div id="view-dashboard" class="fade-in">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800">Chọn Môn Ôn Tập</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <!-- Môn Toán -->
                        <div class="bg-white rounded-xl shadow-md overflow-hidden hover:shadow-lg transition cursor-pointer border-t-4 border-blue-500" onclick="navigateTo('subject-toan')">
                            <div class="p-6">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-xl font-bold text-gray-800">Môn Toán</h3>
                                    <i class="fas fa-calculator text-blue-500 text-2xl"></i>
                                </div>
                                <p class="text-gray-500 text-sm mb-4">Giải tích, Hình học, Xác suất thống kê.</p>
                                <div class="w-full bg-gray-200 rounded-full h-2.5">
                                    <div id="progress-toan" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                                </div>
                                <div class="mt-2 text-right text-xs text-gray-500">Tiến độ: <span id="text-progress-toan">0%</span></div>
                            </div>
                        </div>

                        <!-- Môn Lý -->
                        <div class="bg-white rounded-xl shadow-md overflow-hidden hover:shadow-lg transition cursor-pointer border-t-4 border-purple-500" onclick="navigateTo('subject-ly')">
                            <div class="p-6">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-xl font-bold text-gray-800">Môn Lý</h3>
                                    <i class="fas fa-atom text-purple-500 text-2xl"></i>
                                </div>
                                <p class="text-gray-500 text-sm mb-4">Cơ học, Điện từ, Quang học.</p>
                                <div class="w-full bg-gray-200 rounded-full h-2.5">
                                    <div id="progress-ly" class="bg-purple-600 h-2.5 rounded-full" style="width: 0%"></div>
                                </div>
                                <div class="mt-2 text-right text-xs text-gray-500">Tiến độ: <span id="text-progress-ly">0%</span></div>
                            </div>
                        </div>

                        <!-- Môn Hóa -->
                        <div class="bg-white rounded-xl shadow-md overflow-hidden hover:shadow-lg transition cursor-pointer border-t-4 border-green-500" onclick="navigateTo('subject-hoa')">
                            <div class="p-6">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-xl font-bold text-gray-800">Môn Hóa</h3>
                                    <i class="fas fa-flask text-green-500 text-2xl"></i>
                                </div>
                                <p class="text-gray-500 text-sm mb-4">Vô cơ, Hữu cơ, Phương trình phản ứng.</p>
                                <div class="w-full bg-gray-200 rounded-full h-2.5">
                                    <div id="progress-hoa" class="bg-green-600 h-2.5 rounded-full" style="width: 0%"></div>
                                </div>
                                <div class="mt-2 text-right text-xs text-gray-500">Tiến độ: <span id="text-progress-hoa">0%</span></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 3. NỘI DUNG MÔN HỌC (3 Môn dùng chung template này, đổi data) -->
                <div id="view-subject" class="hidden-section fade-in">
                    <button onclick="navigateTo('dashboard')" class="mb-4 text-blue-600 hover:underline"><i class="fas fa-arrow-left"></i> Quay lại</button>
                    <div class="flex justify-between items-end mb-6">
                        <div>
                            <h2 id="subject-title" class="text-3xl font-bold mb-2">Tên Môn Học</h2>
                            <p class="text-gray-600">Chọn bài học để bắt đầu ôn luyện.</p>
                        </div>
                        <div id="subject-action-area"></div>
                    </div>

                    <div class="bg-white rounded-lg shadow p-6">
                        <div id="subject-content-list" class="space-y-4">
                            <!-- Nội dung sẽ được load động bởi Javascript -->
                        </div>
                    </div>
                </div>

                <!-- 4. NHÓM HỌC TẬP (Chat) -->
                <div id="view-group-chat" class="hidden-section fade-in h-[calc(100vh-140px)] flex flex-col">
                    <h2 class="text-2xl font-bold mb-4">Nhóm Thảo Luận Chung</h2>
                    
                    <div id="chat-box" class="flex-1 bg-white border rounded-t-lg p-4 overflow-y-auto space-y-3">
                        <!-- Tin nhắn sẽ hiển thị ở đây -->
                        <div class="text-center text-gray-400 text-sm italic">Chưa có tin nhắn nào. Hãy bắt đầu thảo luận!</div>
                    </div>

                    <div class="bg-white border-x border-b rounded-b-lg p-4 flex gap-2">
                        <input type="text" id="chat-input" placeholder="Nhập tin nhắn..." class="flex-1 border p-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-400" onkeypress="if(event.key === 'Enter') sendChat()">
                        <button onclick="sendChat()" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700"><i class="fas fa-paper-plane"></i> Gửi</button>
                    </div>
                </div>

                <!-- 5. QUẢN TRỊ VIÊN (Admin Panel) -->
                <div id="view-admin" class="hidden-section fade-in">
                    <h2 class="text-2xl font-bold mb-6 text-red-600">Quản Lý Hệ Thống</h2>
                    
                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <div class="p-4 border-b bg-gray-50 flex justify-between items-center">
                            <h3 class="font-bold">Danh sách người dùng đăng ký</h3>
                            <button onclick="loadUserList()" class="text-sm text-blue-600 hover:underline"><i class="fas fa-sync"></i> Làm mới</button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse">
                                <thead>
                                    <tr class="bg-gray-100 text-sm text-gray-600">
                                        <th class="p-3 border-b">Email</th>
                                        <th class="p-3 border-b">Vai trò</th>
                                        <th class="p-3 border-b">Trạng thái</th>
                                        <th class="p-3 border-b">Hành động</th>
                                    </tr>
                                </thead>
                                <tbody id="user-list-body">
                                    <!-- Danh sách user sẽ load vào đây -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, setDoc, getDoc, updateDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CẤU HÌNH ---
        const firebaseConfig = {
            apiKey: "AIzaSyDB2qnJUEKL0KSwEibU0t-mpBKyzuUt7SE",
            authDomain: "onthi-2026.firebaseapp.com",
            projectId: "onthi-2026",
            storageBucket: "onthi-2026.firebasestorage.app",
            messagingSenderId: "720604280248",
            appId: "1:720604280248:web:1e6a843eb0a0de42158b4d",
            measurementId: "G-HX53LMY9B1"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'onthi-2026';
        
        let currentUser = null;
        let userData = null;

        // --- HÀM TIỆN ÍCH ---
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const colors = type === 'error' ? 'bg-red-500' : (type === 'success' ? 'bg-green-500' : 'bg-blue-500');
            toast.className = `${colors} text-white px-6 py-3 rounded shadow-lg mb-2 fade-in`;
            toast.innerText = message;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function toggleView(viewId) {
            document.querySelectorAll('#main-app > div > main > div').forEach(div => div.classList.add('hidden-section'));
            // Ẩn tất cả view
            document.getElementById('view-dashboard').classList.add('hidden-section');
            document.getElementById('view-subject').classList.add('hidden-section');
            document.getElementById('view-group-chat').classList.add('hidden-section');
            document.getElementById('view-admin').classList.add('hidden-section');
            
            // Hiện view được chọn
            const target = document.getElementById(viewId);
            if(target) target.classList.remove('hidden-section');
        }

        window.navigateTo = (page) => {
            if (page === 'dashboard') {
                toggleView('view-dashboard');
                loadProgress();
            } else if (page.startsWith('subject-')) {
                const subject = page.split('-')[1];
                loadSubject(subject);
            } else if (page === 'group-chat') {
                toggleView('view-group-chat');
                loadChat();
            } else if (page === 'admin-panel') {
                toggleView('view-admin');
                loadUserList();
            }
        };

        // --- AUTH LOGIC ---
        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            }
        };
        initAuth();

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userRef = doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'info');
                const docSnap = await getDoc(userRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data.isBlocked) {
                        showToast('Tài khoản của bạn đã bị khóa bởi Admin.', 'error');
                        signOut(auth);
                        return;
                    }
                    userData = data;
                    currentUser = user;
                    
                    document.getElementById('auth-view').classList.add('hidden');
                    document.getElementById('main-app').classList.remove('hidden-section');
                    document.getElementById('user-display-name').innerText = `Xin chào, ${user.email.split('@')[0]}`;
                    
                    if (userData.role === 'admin') {
                        document.getElementById('admin-menu-item').classList.remove('hidden');
                    } else {
                        document.getElementById('admin-menu-item').classList.add('hidden');
                    }
                    navigateTo('dashboard');
                } else {
                    signOut(auth);
                }
            } else {
                currentUser = null;
                userData = null;
                document.getElementById('auth-view').classList.remove('hidden');
                document.getElementById('main-app').classList.add('hidden-section');
            }
        });

        window.handleLogin = async () => {
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-pass').value;
            if (!email || !pass) return showToast('Vui lòng nhập đủ thông tin', 'error');

            try {
                await signInWithEmailAndPassword(auth, email, pass);
                showToast('Đăng nhập thành công', 'success');
            } catch (e) {
                showToast('Lỗi: ' + e.message, 'error');
            }
        };

        window.handleRegister = async () => {
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-pass').value;
            if (!email || !pass) return showToast('Vui lòng nhập đủ thông tin', 'error');

            try {
                const cred = await createUserWithEmailAndPassword(auth, email, pass);
                const user = cred.user;
                const role = email.includes('admin') ? 'admin' : 'student';

                await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'info'), {
                    email: email,
                    role: role,
                    isBlocked: false,
                    createdAt: serverTimestamp(),
                    progress: { toan: 0, ly: 0, hoa: 0 }
                });
                
                // Add to public directory for admin listing
                try {
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users_directory', user.uid), {
                        email: email,
                        role: role,
                        isBlocked: false
                    });
                } catch(e){}

                showToast(`Đăng ký thành công! Vai trò: ${role}`, 'success');
            } catch (e) {
                showToast('Lỗi đăng ký: ' + e.message, 'error');
            }
        };

        window.handleLogout = () => signOut(auth);

        // --- VIDEO PLAYER & CONTROL LOGIC ---
        let player;
        let videoTimer;
        let maxWatchedTime = 0;
        let currentVideoDuration = 0;
        let isPlayerReady = false;

        // Trích xuất ID từ URL Youtube
        function getYoutubeId(url) {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }

        // Khởi tạo Youtube Player
        // 1. Gán hàm callback vào window ĐẦU TIÊN
        window.onYouTubeIframeAPIReady = function() {
            console.log("YouTube API Ready");
            player = new YT.Player('youtube-player', {
                height: '100%',
                width: '100%',
                playerVars: {
                    'playsinline': 1,
                    'controls': 0, // Ẩn control mặc định
                    'disablekb': 1, // Tắt bàn phím
                    'rel': 0, // Tắt video liên quan
                    'modestbranding': 1,
                    'origin': window.location.origin // Quan trọng để tránh lỗi CORS
                },
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange,
                    'onError': onPlayerError
                }
            });
        }

        // 2. Sau đó mới Inject script (Dynamic Injection)
        function loadYouTubeAPI() {
            if (!window.YT) {
                var tag = document.createElement('script');
                tag.src = "https://www.youtube.com/iframe_api";
                var firstScriptTag = document.getElementsByTagName('script')[0];
                firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
            }
        }
        loadYouTubeAPI();

        function onPlayerReady(event) {
            console.log("Player Ready");
            isPlayerReady = true;
        }

        function onPlayerError(event) {
            console.error("Youtube Player Error:", event.data);
            showToast("Lỗi tải video. Vui lòng kiểm tra lại link.", "error");
        }

        function onPlayerStateChange(event) {
            const btnIcon = document.querySelector('#btn-play-pause i');
            if (event.data == YT.PlayerState.PLAYING) {
                btnIcon.className = 'fas fa-pause';
                startVideoTracking();
            } else {
                btnIcon.className = 'fas fa-play';
                stopVideoTracking();
            }
        }

        function startVideoTracking() {
            stopVideoTracking(); // Clear old interval if exists
            videoTimer = setInterval(() => {
                if (!player || !player.getCurrentTime) return;

                const currentTime = player.getCurrentTime();
                const duration = player.getDuration();
                
                // 1. ANTI-SEEK: Chống tua
                if (currentTime > maxWatchedTime + 2) { // Cho phép sai số 2s
                    player.seekTo(maxWatchedTime);
                    showToast("Không được tua video!", "error");
                } else {
                    if (currentTime > maxWatchedTime) {
                        maxWatchedTime = currentTime;
                    }
                }

                // 2. ANTI-MUTE: Chống tắt tiếng
                if (player.isMuted()) {
                    player.pauseVideo();
                    document.getElementById('mute-warning').classList.remove('hidden');
                } else {
                    document.getElementById('mute-warning').classList.add('hidden');
                }

                // 3. CẬP NHẬT UI TIẾN ĐỘ
                updatePlayerUI(currentTime, duration);

                // 4. CẬP NHẬT TIẾN ĐỘ TỔNG (mỗi 10s hoặc khi xong)
                const percent = (maxWatchedTime / duration) * 100;
                if (percent > 90) { // Coi như xong nếu xem > 90%
                    // Gọi hàm update progress tổng của môn học
                    // Quy đổi: Mỗi video hoàn thành = cộng thêm điểm vào tiến độ môn
                    // Ở đây để đơn giản ta gọi hàm cập nhật nhẹ
                }

            }, 1000);
        }

        function stopVideoTracking() {
            if (videoTimer) clearInterval(videoTimer);
        }

        function updatePlayerUI(current, duration) {
            if (!duration) return;
            const formatTime = (s) => {
                const m = Math.floor(s / 60);
                const sec = Math.floor(s % 60);
                return `${m < 10 ? '0'+m : m}:${sec < 10 ? '0'+sec : sec}`;
            };

            document.getElementById('time-display').innerText = `${formatTime(current)} / ${formatTime(duration)}`;
            
            const currentPercent = (current / duration) * 100;
            const maxPercent = (maxWatchedTime / duration) * 100;
            
            document.getElementById('video-progress-bar').style.width = `${currentPercent}%`;
            document.getElementById('max-watched-marker').style.width = `${maxPercent}%`;
            document.getElementById('max-watched-display').innerText = `${Math.round(maxPercent)}%`;
            
            // Nếu xem xong, tự cộng điểm
            if (Math.round(maxPercent) >= 95 && !window.videoCompletedFlag) {
                 window.videoCompletedFlag = true;
                 updateSubjectProgress(5); // Cộng 5% tiến độ môn học
                 showToast("Chúc mừng! Bạn đã hoàn thành bài học này.", "success");
            }
        }

        window.openVideoModal = (url, title) => {
            const videoId = getYoutubeId(url);
            if (!videoId) return showToast("Link video không hợp lệ", "error");

            document.getElementById('modal-video-title').innerText = title;
            document.getElementById('video-modal').classList.remove('hidden');
            
            maxWatchedTime = 0;
            window.videoCompletedFlag = false;
            document.getElementById('max-watched-display').innerText = "0%";
            document.getElementById('video-progress-bar').style.width = "0%";
            
            if (isPlayerReady) {
                player.loadVideoById(videoId);
                player.unMute(); // Cố gắng bật tiếng
                player.playVideo();
            } else {
                // Nếu chưa ready, đợi 1 lát rồi thử lại (fallback)
                 setTimeout(() => {
                    if(player && player.loadVideoById) {
                        player.loadVideoById(videoId);
                        player.playVideo();
                    }
                 }, 1000);
            }
        };

        window.closeVideoModal = () => {
            document.getElementById('video-modal').classList.add('hidden');
            if (player && player.stopVideo) {
                player.stopVideo();
            }
            stopVideoTracking();
        };

        window.togglePlayPause = () => {
            if (!player) return;
            const state = player.getPlayerState();
            if (state == YT.PlayerState.PLAYING) {
                player.pauseVideo();
            } else {
                player.playVideo();
            }
        };

        window.toggleFullscreen = () => {
            const elem = document.getElementById('fullscreen-container');
            if (!document.fullscreenElement) {
                elem.requestFullscreen().catch(err => {
                    alert(`Lỗi không thể phóng to: ${err.message}`);
                });
            } else {
                document.exitFullscreen();
            }
        };

        window.unmuteVideo = () => {
            if (player) {
                player.unMute();
                player.playVideo();
                document.getElementById('mute-warning').classList.add('hidden');
            }
        };


        // --- LOGIC MÔN HỌC & TIẾN ĐỘ ---
        function loadProgress() {
            if (!userData || !userData.progress) return;
            ['toan', 'ly', 'hoa'].forEach(subj => {
                const val = userData.progress[subj] || 0;
                document.getElementById(`progress-${subj}`).style.width = `${val}%`;
                document.getElementById(`text-progress-${subj}`).innerText = `${val}%`;
            });
        }

        const chemistryVideos = [
            { title: "Giải đề thi môn Hoá học | Kỳ thi tốt nghiệp THPT 2025", url: "https://youtu.be/8nfiPbueiPI?si=Ieyiskl3BnwnNV2-", author: "HTV - Đài Hà Nội" },
            { title: "Đề ôn thi Tốt nghiệp THPT Hóa học năm 2025 – Tổng Ôn", url: "https://www.youtube.com/watch?v=y9VcYDPug_g", author: "VietJack THPT Official" },
            { title: "Giải mã đề Hóa học thi Tốt nghiệp THPT năm 2025", url: "https://www.youtube.com/watch?v=xe1OYRPf5RQ", author: "Thầy Lâm Mạnh Cường" }
        ];

        const mathVideos = [
            { title: "Tổng ôn Toán 12: Nguyên hàm - Tích phân", url: "https://www.youtube.com/watch?v=example1", author: "Thầy Nguyễn Quốc Chí" },
            { title: "Bí kíp giải nhanh Hình học không gian", url: "https://www.youtube.com/watch?v=example2", author: "VTV7" }
        ];

        const physicsVideos = [
            { title: "Vật Lý 12: Dao động cơ học (Phần 1)", url: "https://www.youtube.com/watch?v=exampleLy1", author: "Thầy Phạm Trung Dũng" },
            { title: "Dòng điện xoay chiều - Lý thuyết trọng tâm", url: "https://www.youtube.com/watch?v=exampleLy2", author: "Tuyensinh247" }
        ];

        const mathExams = [
            { title: "Đề thi thử Toán THPT 2025 - Sở Hà Nội", url: "#", source: "Sở GD&ĐT Hà Nội" }
        ];
        const physicsExams = [];
        const chemistryExams = [
            { title: "Bộ 50 câu trắc nghiệm Este - Lipit (Có đáp án)", url: "#", source: "Moon.vn" }
        ];

        let currentSubject = '';
        function loadSubject(subject) {
            currentSubject = subject;
            toggleView('view-subject');
            const titles = { 'toan': 'Môn Toán Học', 'ly': 'Môn Vật Lý', 'hoa': 'Môn Hóa Học' };
            document.getElementById('subject-title').innerText = titles[subject];
            
            const contentArea = document.getElementById('subject-content-list');
            contentArea.innerHTML = ''; 

            let selectedVideos = [];
            let selectedExams = [];

            if (subject === 'hoa') {
                selectedVideos = chemistryVideos;
                selectedExams = chemistryExams;
            } else if (subject === 'toan') {
                selectedVideos = mathVideos;
                selectedExams = mathExams;
            } else if (subject === 'ly') {
                selectedVideos = physicsVideos;
                selectedExams = physicsExams;
            }

            // 1. HIỂN THỊ DANH SÁCH VIDEO (CẬP NHẬT GỌI MODAL)
            if (selectedVideos.length > 0) {
                 const videoHeader = document.createElement('h3');
                 videoHeader.className = "text-xl font-bold mb-4 text-blue-800 flex items-center";
                 videoHeader.innerHTML = '<i class="fab fa-youtube text-red-600 mr-2"></i> Bài Giảng Video (Bắt buộc xem)';
                 contentArea.appendChild(videoHeader);

                 selectedVideos.forEach((vid, index) => {
                     const div = document.createElement('div');
                     div.className = 'flex items-center justify-between p-4 border rounded hover:bg-blue-50 transition bg-white mb-3 shadow-sm';
                     // Thay đổi onclick để mở modal
                     div.innerHTML = `
                        <div class="flex items-start space-x-3 overflow-hidden cursor-pointer" onclick="openVideoModal('${vid.url}', '${vid.title}')">
                            <div class="flex-shrink-0 mt-1">
                                <i class="fas fa-play-circle text-blue-500 text-2xl"></i>
                            </div>
                            <div class="overflow-hidden">
                                <h4 class="font-bold text-gray-800 hover:underline truncate">Bài ${index + 1}: ${vid.title}</h4>
                                <p class="text-sm text-gray-500"><i class="fas fa-user-tie mr-1"></i> ${vid.author}</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                             <button onclick="openVideoModal('${vid.url}', '${vid.title}')" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm font-bold transition flex items-center shadow">
                                <i class="fas fa-play mr-1"></i> Học Ngay
                            </button>
                        </div>
                     `;
                     contentArea.appendChild(div);
                 });
            } else {
                contentArea.innerHTML += `<div class="p-4 text-gray-500 italic text-center">Chưa có bài giảng video nào.</div>`;
            }

            // 2. HIỂN THỊ DANH SÁCH ĐỀ THI
            if (selectedExams.length > 0) {
                 const examHeader = document.createElement('h3');
                 examHeader.className = "text-xl font-bold mt-8 mb-4 text-yellow-700 flex items-center border-t pt-6";
                 examHeader.innerHTML = '<i class="fas fa-file-alt text-yellow-500 mr-2"></i> Tài Liệu & Đề Thi';
                 contentArea.appendChild(examHeader);

                 selectedExams.forEach((doc, index) => {
                     const div = document.createElement('div');
                     div.className = 'flex items-center justify-between p-4 border rounded hover:bg-yellow-50 transition bg-white mb-3 shadow-sm border-l-4 border-yellow-400';
                     div.innerHTML = `
                        <div class="flex items-start space-x-3 overflow-hidden">
                            <div class="flex-shrink-0 mt-1">
                                <i class="fas fa-file-pdf text-red-500 text-2xl"></i>
                            </div>
                            <div class="overflow-hidden">
                                <h4 class="font-bold text-gray-800 hover:underline truncate"><a href="${doc.url}" target="_blank">${doc.title}</a></h4>
                                <p class="text-sm text-gray-500"><i class="fas fa-source mr-1"></i> Nguồn: ${doc.source}</p>
                            </div>
                        </div>
                        <a href="${doc.url}" target="_blank" class="flex-shrink-0 px-4 py-2 bg-yellow-100 text-yellow-800 rounded-full hover:bg-yellow-200 text-sm font-bold transition flex items-center">
                            <i class="fas fa-download mr-1"></i> Tải về
                        </a>
                     `;
                     contentArea.appendChild(div);
                 });
            }
        }

        window.updateSubjectProgress = async (amount) => {
            if (!currentUser || !currentSubject) return;
            const newProgress = Math.min((userData.progress[currentSubject] || 0) + amount, 100);
            
            userData.progress[currentSubject] = newProgress;
            try {
                const userRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profile', 'info');
                await updateDoc(userRef, {
                    [`progress.${currentSubject}`]: newProgress
                });
                loadProgress();
            } catch (e) {}
        };

        // --- CHAT LOGIC VÀ ADMIN LOGIC (GIỮ NGUYÊN) ---
        // ... (Logic Chat và Admin giữ nguyên như cũ để tiết kiệm không gian, 
        // code đã bao gồm trong logic trên thông qua các hàm loadChat, sendChat, loadUserList...)
        let chatUnsubscribe = null;
        function loadChat() {
            const chatList = document.getElementById('chat-box');
            chatList.innerHTML = '<div class="text-center text-gray-400">Đang tải...</div>';
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'group_chat'), orderBy('createdAt', 'asc'));
            if (chatUnsubscribe) chatUnsubscribe();
            chatUnsubscribe = onSnapshot(q, (snapshot) => {
                chatList.innerHTML = '';
                snapshot.forEach(doc => {
                    const msg = doc.data();
                    const isMe = msg.uid === currentUser.uid;
                    const div = document.createElement('div');
                    div.className = `flex ${isMe ? 'justify-end' : 'justify-start'}`;
                    div.innerHTML = `
                        <div class="max-w-[70%] rounded-lg p-2 text-sm ${isMe ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-800'}">
                            <div class="text-xs opacity-75 mb-1 font-bold">${msg.email.split('@')[0]}</div>
                            ${msg.text}
                        </div>`;
                    chatList.appendChild(div);
                });
                chatList.scrollTop = chatList.scrollHeight;
            });
        }
        window.sendChat = async () => {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (!text) return;
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'group_chat'), {
                    text: text, uid: currentUser.uid, email: currentUser.email, createdAt: serverTimestamp()
                });
                input.value = '';
            } catch (e) { showToast('Lỗi gửi tin', 'error'); }
        };
        window.loadUserList = async () => {
             if (userData.role !== 'admin') return;
             const tbody = document.getElementById('user-list-body');
             tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center">Đang tải...</td></tr>';
             try {
                 const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'users_directory'));
                 const snapshot = await getDocs(q);
                 tbody.innerHTML = '';
                 if (snapshot.empty) tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center">Chưa có user.</td></tr>';
                 snapshot.forEach(doc => renderUserRow(tbody, { id: doc.id, ...doc.data() }));
             } catch (e) { tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center">Lỗi tải dữ liệu.</td></tr>'; }
        };
        function renderUserRow(tbody, user) {
            const tr = document.createElement('tr');
            tr.className = "border-b hover:bg-gray-50";
            tr.innerHTML = `<td class="p-3">${user.email}</td><td class="p-3">${user.role}</td><td class="p-3">${user.isBlocked ? 'Khóa' : 'Hoạt động'}</td>
                <td class="p-3">${user.role !== 'admin' ? `<button onclick="toggleBlock('${user.id}', ${!user.isBlocked})" class="border px-2 py-1 text-xs rounded">${user.isBlocked ? 'Mở' : 'Khóa'}</button>` : ''}</td>`;
            tbody.appendChild(tr);
        }
        window.toggleBlock = async (uid, blockStatus) => {
            if (!confirm('Xác nhận đổi trạng thái?')) return;
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users_directory', uid), { isBlocked: blockStatus });
            loadUserList();
            showToast('Đã cập nhật', 'success');
        };

    </script>
</body>
</html>