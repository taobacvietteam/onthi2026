<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ Thống Ôn Thi TN THPT 2026</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .hidden-section { display: none !important; }
        
        /* Video & Exam Modal Styles */
        .modal-overlay { background-color: rgba(0, 0, 0, 0.95); }
        .video-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; background: #000; }
        .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .video-blocker { position: absolute; top: 0; left: 0; width: 100%; height: 85%; z-index: 10; background: transparent; cursor: pointer; }
        
        /* Exam Iframe */
        .exam-frame { width: 100%; height: 80vh; border: none; background: white; }
    </style>
</head>
<body class="bg-gray-100 font-sans text-gray-800">

    <div id="toast-container" class="fixed top-5 right-5 z-50"></div>

    <!-- MODAL XEM VIDEO -->
    <div id="video-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-overlay">
        <div class="bg-white w-full max-w-5xl rounded-lg overflow-hidden shadow-2xl flex flex-col max-h-[95vh]">
            <div class="p-3 bg-gray-900 text-white flex justify-between items-center">
                <h3 id="modal-video-title" class="font-bold text-lg truncate pr-4">Bài học</h3>
                <button onclick="closeVideoModal()" class="text-gray-400 hover:text-white px-2"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="relative bg-black flex-1 flex flex-col justify-center" id="fullscreen-container">
                <div class="video-container">
                    <div id="youtube-player"></div>
                    <div class="video-blocker" onclick="togglePlayPause()" title="Bấm để Phát/Dừng"></div>
                </div>
                <div id="mute-warning" class="hidden absolute inset-0 bg-black bg-opacity-90 z-20 flex flex-col items-center justify-center text-white text-center p-4">
                    <i class="fas fa-volume-mute text-5xl text-red-500 mb-4"></i>
                    <h2 class="text-2xl font-bold">Vui lòng bật tiếng!</h2>
                    <p>Hệ thống yêu cầu bật âm thanh để ghi nhận tiến độ.</p>
                    <button onclick="unmuteVideo()" class="mt-4 px-6 py-2 bg-blue-600 rounded hover:bg-blue-700 font-bold">Bật tiếng ngay</button>
                </div>
            </div>
            <div class="bg-gray-800 text-white p-4">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center space-x-4">
                        <button id="btn-play-pause" onclick="togglePlayPause()" class="hover:text-blue-400 w-8"><i class="fas fa-play"></i></button>
                        <span class="text-sm font-mono" id="time-display">00:00 / 00:00</span>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span class="text-xs text-gray-400 mr-2">Đã xem: <span id="max-watched-display" class="text-green-400">0%</span></span>
                        <button onclick="toggleFullscreen()" class="hover:text-blue-400"><i class="fas fa-expand"></i> Zoom</button>
                    </div>
                </div>
                <div class="w-full bg-gray-600 h-2 rounded-full relative">
                    <div id="video-progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300 relative z-10" style="width: 0%"></div>
                    <div id="max-watched-marker" class="absolute top-0 left-0 h-2 bg-green-500 opacity-50 z-0" style="width: 0%"></div>
                </div>
                <p class="text-xs text-gray-500 mt-2 text-center italic">Bạn có thể tua lại phần màu xanh lá (phần đã học).</p>
            </div>
        </div>
    </div>

    <!-- MODAL THI ONLINE -->
    <div id="exam-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-overlay">
        <div class="bg-white w-full max-w-6xl h-[90vh] rounded-lg overflow-hidden shadow-2xl flex flex-col">
            <div class="p-3 bg-blue-900 text-white flex justify-between items-center">
                <div class="flex items-center">
                    <i class="fas fa-edit mr-2"></i>
                    <h3 id="exam-modal-title" class="font-bold text-lg">Làm Bài Thi</h3>
                </div>
                <button onclick="closeExamModal()" class="bg-red-500 hover:bg-red-600 px-3 py-1 rounded text-sm">Kết thúc bài thi</button>
            </div>
            <div class="flex-1 bg-gray-100 relative">
                <div id="exam-loading" class="absolute inset-0 flex items-center justify-center text-gray-500">
                    <i class="fas fa-spinner fa-spin mr-2"></i> Đang tải đề thi...
                </div>
                <iframe id="exam-iframe" class="exam-frame" src="" onload="document.getElementById('exam-loading').style.display='none'"></iframe>
            </div>
        </div>
    </div>

    <!-- 1. MÀN HÌNH ĐĂNG NHẬP / ĐĂNG KÝ -->
    <div id="auth-view" class="min-h-screen flex items-center justify-center bg-gradient-to-r from-blue-500 to-purple-600 p-4">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-md">
            <h1 class="text-3xl font-bold text-center mb-6 text-blue-800">Ôn Thi THPT 2026</h1>
            <div class="flex justify-center mb-6"><i class="fas fa-graduation-cap text-6xl text-blue-500"></i></div>
            <div class="space-y-4">
                <input type="email" id="auth-email" placeholder="Email (dùng email thật)" class="w-full p-3 border rounded focus:outline-none focus:ring-2 focus:ring-blue-400">
                <input type="password" id="auth-pass" placeholder="Mật khẩu (tối thiểu 6 ký tự)" class="w-full p-3 border rounded focus:outline-none focus:ring-2 focus:ring-blue-400">
                <button onclick="handleLogin()" class="w-full bg-blue-600 text-white p-3 rounded hover:bg-blue-700 font-bold transition">Đăng Nhập</button>
                <button onclick="handleRegister()" class="w-full bg-gray-200 text-gray-700 p-3 rounded hover:bg-gray-300 font-bold transition">Đăng Ký & Xác Thực Email</button>
            </div>
            <p class="text-xs text-center text-gray-500 mt-4">Lưu ý: Bạn phải xác thực email mới được vào học.</p>
        </div>
    </div>

    <!-- 1b. MÀN HÌNH CHỜ XÁC THỰC EMAIL -->
    <div id="verify-email-view" class="hidden-section min-h-screen flex items-center justify-center bg-gray-100 p-4">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md text-center">
            <i class="fas fa-envelope-open-text text-6xl text-yellow-500 mb-4"></i>
            <h2 class="text-2xl font-bold mb-2">Vui lòng xác thực Email</h2>
            <p class="text-gray-600 mb-6">Chúng tôi đã gửi link xác thực đến <strong id="verify-email-display">email</strong>. Vui lòng kiểm tra hộp thư (cả mục Spam) và bấm vào link để kích hoạt tài khoản.</p>
            <div class="space-y-3">
                <button onclick="checkVerification()" class="w-full bg-blue-600 text-white p-3 rounded hover:bg-blue-700 font-bold">Tôi đã xác thực xong</button>
                <button onclick="resendVerification()" class="w-full border border-blue-600 text-blue-600 p-3 rounded hover:bg-blue-50">Gửi lại email</button>
                <button onclick="handleLogout()" class="text-sm text-gray-500 hover:underline">Đăng xuất</button>
            </div>
        </div>
    </div>

    <!-- GIAO DIỆN CHÍNH -->
    <div id="main-app" class="hidden-section min-h-screen flex flex-col">
        <nav class="bg-blue-800 text-white shadow-lg">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                <div class="flex items-center space-x-2 cursor-pointer" onclick="navigateTo('dashboard')">
                    <i class="fas fa-book-open text-xl"></i>
                    <span class="text-xl font-bold hidden md:block">Luyện Thi 2026</span>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="user-display-name" class="font-medium">User</span>
                    <button onclick="handleLogout()" class="bg-red-500 hover:bg-red-600 px-3 py-1 rounded text-sm transition"><i class="fas fa-sign-out-alt"></i> Thoát</button>
                </div>
            </div>
        </nav>

        <div class="flex flex-1 overflow-hidden">
            <aside class="w-64 bg-white shadow-md hidden md:block flex-col">
                <div class="p-4 border-b"><h3 class="font-bold text-gray-500 uppercase text-xs">Menu Chính</h3></div>
                <nav class="flex-1 p-4 space-y-2">
                    <button onclick="navigateTo('dashboard')" class="w-full text-left px-4 py-2 rounded hover:bg-blue-50 text-blue-700 font-medium"><i class="fas fa-home w-6"></i> Trang Chủ</button>
                    <button onclick="navigateTo('online-class')" class="w-full text-left px-4 py-2 rounded hover:bg-blue-50 text-green-600 font-medium"><i class="fas fa-video w-6"></i> Lớp Trực Tuyến</button>
                    <button onclick="navigateTo('group-chat')" class="w-full text-left px-4 py-2 rounded hover:bg-blue-50 text-gray-600 hover:text-blue-700"><i class="fas fa-comments w-6"></i> Nhóm Thảo Luận</button>
                    <div id="admin-menu-item" class="hidden">
                        <div class="mt-4 mb-2 px-4 text-xs font-bold text-gray-400 uppercase">Quản Trị</div>
                        <button onclick="navigateTo('admin-panel')" class="w-full text-left px-4 py-2 rounded hover:bg-red-50 text-red-600 font-medium"><i class="fas fa-user-shield w-6"></i> Quản Lý Học Viên</button>
                    </div>
                </nav>
            </aside>

            <main class="flex-1 p-6 overflow-y-auto bg-gray-50" id="content-area">
                <!-- DASHBOARD -->
                <div id="view-dashboard" class="fade-in">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800">Chọn Môn Ôn Tập</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-white rounded-xl shadow p-6 cursor-pointer border-t-4 border-blue-500 hover:shadow-lg" onclick="navigateTo('subject-toan')">
                            <h3 class="text-xl font-bold mb-2">Môn Toán</h3>
                            <div class="w-full bg-gray-200 rounded-full h-2.5"><div id="progress-toan" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div></div>
                            <div class="text-right text-xs mt-1">Tiến độ: <span id="text-progress-toan">0%</span></div>
                        </div>
                        <div class="bg-white rounded-xl shadow p-6 cursor-pointer border-t-4 border-purple-500 hover:shadow-lg" onclick="navigateTo('subject-ly')">
                            <h3 class="text-xl font-bold mb-2">Môn Lý</h3>
                            <div class="w-full bg-gray-200 rounded-full h-2.5"><div id="progress-ly" class="bg-purple-600 h-2.5 rounded-full" style="width: 0%"></div></div>
                            <div class="text-right text-xs mt-1">Tiến độ: <span id="text-progress-ly">0%</span></div>
                        </div>
                        <div class="bg-white rounded-xl shadow p-6 cursor-pointer border-t-4 border-green-500 hover:shadow-lg" onclick="navigateTo('subject-hoa')">
                            <h3 class="text-xl font-bold mb-2">Môn Hóa</h3>
                            <div class="w-full bg-gray-200 rounded-full h-2.5"><div id="progress-hoa" class="bg-green-600 h-2.5 rounded-full" style="width: 0%"></div></div>
                            <div class="text-right text-xs mt-1">Tiến độ: <span id="text-progress-hoa">0%</span></div>
                        </div>
                    </div>
                </div>

                <!-- LỚP ONLINE -->
                <div id="view-online-class" class="hidden-section fade-in">
                    <h2 class="text-2xl font-bold mb-4 text-green-700">Lịch Học Trực Tuyến (Live)</h2>
                    <div class="bg-white p-6 rounded shadow">
                        <div class="mb-4 border-l-4 border-green-500 pl-4 py-2 bg-green-50">
                            <h4 class="font-bold">Ca sáng: 08:00 - 10:00 (Thứ 2, 4, 6)</h4>
                            <p class="text-sm">Chuyên đề: Giải tích 12</p>
                            <a href="#" class="inline-block mt-2 bg-green-600 text-white px-4 py-1 rounded text-sm hover:bg-green-700">Vào lớp (Google Meet)</a>
                        </div>
                        <div class="border-l-4 border-blue-500 pl-4 py-2 bg-blue-50">
                            <h4 class="font-bold">Ca tối: 19:30 - 21:30 (Thứ 3, 5, 7)</h4>
                            <p class="text-sm">Chuyên đề: Hóa Vô Cơ</p>
                            <a href="#" class="inline-block mt-2 bg-blue-600 text-white px-4 py-1 rounded text-sm hover:bg-blue-700">Vào lớp (Zoom)</a>
                        </div>
                    </div>
                </div>

                <!-- SUBJECT DETAIL -->
                <div id="view-subject" class="hidden-section fade-in">
                    <button onclick="navigateTo('dashboard')" class="mb-4 text-blue-600 hover:underline"><i class="fas fa-arrow-left"></i> Quay lại</button>
                    <h2 id="subject-title" class="text-3xl font-bold mb-6">Môn Học</h2>
                    <div class="bg-white rounded-lg shadow p-6" id="subject-content-list"></div>
                </div>

                <!-- CHAT -->
                <div id="view-group-chat" class="hidden-section fade-in h-[calc(100vh-140px)] flex flex-col">
                    <h2 class="text-2xl font-bold mb-4">Nhóm Thảo Luận</h2>
                    <div id="chat-box" class="flex-1 bg-white border rounded-t-lg p-4 overflow-y-auto space-y-3"></div>
                    <div class="bg-white border-x border-b rounded-b-lg p-4 flex gap-2">
                        <input type="text" id="chat-input" placeholder="Nhập tin nhắn..." class="flex-1 border p-2 rounded" onkeypress="if(event.key === 'Enter') sendChat()">
                        <button onclick="sendChat()" class="bg-blue-600 text-white px-6 py-2 rounded">Gửi</button>
                    </div>
                </div>

                <!-- ADMIN PANEL -->
                <div id="view-admin" class="hidden-section fade-in">
                    <h2 class="text-2xl font-bold mb-6 text-red-600">Quản Trị Hệ Thống</h2>
                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <div class="p-4 border-b bg-gray-50 flex justify-between items-center">
                            <h3 class="font-bold">Tiến Độ Học Viên</h3>
                            <button onclick="loadUserList()" class="text-sm text-blue-600 hover:underline"><i class="fas fa-sync"></i> Refresh</button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse text-sm">
                                <thead>
                                    <tr class="bg-gray-100 text-gray-600">
                                        <th class="p-3 border-b">Email</th>
                                        <th class="p-3 border-b text-center">Toán</th>
                                        <th class="p-3 border-b text-center">Lý</th>
                                        <th class="p-3 border-b text-center">Hóa</th>
                                        <th class="p-3 border-b">Trạng thái</th>
                                        <th class="p-3 border-b">Hành động</th>
                                    </tr>
                                </thead>
                                <tbody id="user-list-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Firebase & YouTube SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, signInWithCustomToken, sendEmailVerification } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, setDoc, getDoc, updateDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // CONFIG FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyDB2qnJUEKL0KSwEibU0t-mpBKyzuUt7SE",
            authDomain: "onthi-2026.firebaseapp.com",
            projectId: "onthi-2026",
            storageBucket: "onthi-2026.firebasestorage.app",
            messagingSenderId: "720604280248",
            appId: "1:720604280248:web:1e6a843eb0a0de42158b4d",
            measurementId: "G-HX53LMY9B1"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'onthi-2026';
        let currentUser = null, userData = null;

        // --- AUTH SYSTEM ---
        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
        };
        initAuth();

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // 1. Kiểm tra trong DB (Block check)
                const userRef = doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'info');
                const docSnap = await getDoc(userRef);

                if (!docSnap.exists()) { signOut(auth); return; }
                const data = docSnap.data();

                // KHÓA CHẶT CHẼ: Nếu bị block -> Logout ngay
                if (data.isBlocked) {
                    await signOut(auth);
                    alert("Tài khoản của bạn đã bị KHÓA vĩnh viễn do vi phạm quy định.");
                    window.location.reload();
                    return;
                }

                // XÁC THỰC EMAIL: Nếu chưa xác thực -> Chuyển hướng
                if (!user.emailVerified) {
                    document.getElementById('auth-view').classList.add('hidden');
                    document.getElementById('main-app').classList.add('hidden-section');
                    document.getElementById('verify-email-view').classList.remove('hidden-section');
                    document.getElementById('verify-email-display').innerText = user.email;
                    return;
                }

                // Nếu mọi thứ OK -> Vào App
                userData = data;
                currentUser = user;
                
                document.getElementById('auth-view').classList.add('hidden');
                document.getElementById('verify-email-view').classList.add('hidden-section');
                document.getElementById('main-app').classList.remove('hidden-section');
                document.getElementById('user-display-name').innerText = user.email.split('@')[0];
                
                if (userData.role === 'admin') document.getElementById('admin-menu-item').classList.remove('hidden');
                navigateTo('dashboard');
            } else {
                // Chưa login
                currentUser = null; userData = null;
                document.getElementById('auth-view').classList.remove('hidden');
                document.getElementById('verify-email-view').classList.add('hidden-section');
                document.getElementById('main-app').classList.add('hidden-section');
            }
        });

        window.handleLogin = async () => {
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-pass').value;
            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (e) { showToast('Lỗi: ' + e.message, 'error'); }
        };

        window.handleRegister = async () => {
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-pass').value;
            try {
                const cred = await createUserWithEmailAndPassword(auth, email, pass);
                const user = cred.user;
                
                // Gửi email xác thực
                await sendEmailVerification(user);

                // Cập nhật logic xác định admin tại đây
                const role = (email.toLowerCase() === 'taobacvietteam@gmail.com') ? 'admin' : 'student';
                
                const initialData = {
                    email: email, role: role, isBlocked: false,
                    progress: { toan: 0, ly: 0, hoa: 0 }
                };

                // Lưu dữ liệu riêng tư
                await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'info'), initialData);
                
                // Lưu dữ liệu công khai để Admin theo dõi tiến độ
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users_directory', user.uid), initialData);

                showToast('Đăng ký thành công! Vui lòng kiểm tra email để xác thực.', 'success');
            } catch (e) { showToast('Lỗi: ' + e.message, 'error'); }
        };

        window.resendVerification = async () => {
            if(auth.currentUser) {
                await sendEmailVerification(auth.currentUser);
                showToast('Đã gửi lại email xác thực.', 'success');
            }
        };

        window.checkVerification = async () => {
            if(auth.currentUser) {
                await auth.currentUser.reload();
                if(auth.currentUser.emailVerified) {
                    window.location.reload(); // Reload để trigger onAuthStateChanged
                } else {
                    showToast('Bạn chưa xác thực email. Hãy kiểm tra hộp thư.', 'error');
                }
            }
        };

        window.handleLogout = () => signOut(auth);

        // --- NAVIGATION ---
        window.navigateTo = (page) => {
            document.querySelectorAll('#main-app > div > main > div').forEach(div => div.classList.add('hidden-section'));
            if (page === 'dashboard') {
                document.getElementById('view-dashboard').classList.remove('hidden-section');
                loadProgress();
            } else if (page === 'online-class') {
                document.getElementById('view-online-class').classList.remove('hidden-section');
            } else if (page.startsWith('subject-')) {
                document.getElementById('view-subject').classList.remove('hidden-section');
                loadSubject(page.split('-')[1]);
            } else if (page === 'group-chat') {
                document.getElementById('view-group-chat').classList.remove('hidden-section');
                loadChat();
            } else if (page === 'admin-panel') {
                document.getElementById('view-admin').classList.remove('hidden-section');
                loadUserList();
            }
        };

        // --- VIDEO PLAYER INTELLIGENT SEEKING ---
        let player, videoTimer, maxWatchedTime = 0;
        
        // Load YouTube API dynamically
        if (!window.YT) {
            var tag = document.createElement('script');
            tag.src = "https://www.youtube.com/iframe_api";
            var firstScriptTag = document.getElementsByTagName('script')[0];
            firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
        }

        window.onYouTubeIframeAPIReady = function() {
            player = new YT.Player('youtube-player', {
                height: '100%', width: '100%',
                playerVars: { 'playsinline': 1, 'controls': 0, 'disablekb': 1, 'rel': 0, 'origin': window.location.origin },
                events: { 'onStateChange': onPlayerStateChange }
            });
        }

        function onPlayerStateChange(event) {
            const btnIcon = document.querySelector('#btn-play-pause i');
            if (event.data == YT.PlayerState.PLAYING) {
                btnIcon.className = 'fas fa-pause';
                startVideoTracking();
            } else {
                btnIcon.className = 'fas fa-play';
                stopVideoTracking();
            }
        }

        function startVideoTracking() {
            stopVideoTracking();
            videoTimer = setInterval(() => {
                if (!player || !player.getCurrentTime) return;
                const currentTime = player.getCurrentTime();
                const duration = player.getDuration();
                
                // LOGIC TUA THÔNG MINH:
                // Nếu tua quá điểm maxWatchedTime + 3s -> Chặn và quay lại
                // Cho phép tua thoải mái trong vùng < maxWatchedTime
                if (currentTime > maxWatchedTime + 3) { 
                    player.seekTo(maxWatchedTime);
                    showToast("Bạn chưa học đến đoạn này, không được tua!", "error");
                } else {
                    if (currentTime > maxWatchedTime) maxWatchedTime = currentTime;
                }

                if (player.isMuted()) {
                    player.pauseVideo();
                    document.getElementById('mute-warning').classList.remove('hidden');
                } else {
                    document.getElementById('mute-warning').classList.add('hidden');
                }

                updatePlayerUI(currentTime, duration);
            }, 1000);
        }
        function stopVideoTracking() { clearInterval(videoTimer); }

        function updatePlayerUI(current, duration) {
            const format = s => new Date(s * 1000).toISOString().substr(14, 5);
            document.getElementById('time-display').innerText = `${format(current)} / ${format(duration)}`;
            const pct = (current / duration) * 100;
            const maxPct = (maxWatchedTime / duration) * 100;
            
            document.getElementById('video-progress-bar').style.width = `${pct}%`;
            document.getElementById('max-watched-marker').style.width = `${maxPct}%`;
            document.getElementById('max-watched-display').innerText = `${Math.round(maxPct)}%`;
            
            if (maxPct > 90 && !window.videoCompletedFlag) {
                window.videoCompletedFlag = true;
                updateSubjectProgress(5); 
                showToast("Đã hoàn thành bài học (+5%)", "success");
            }
        }

        window.openVideoModal = (url, title) => {
            const id = url.match(/(?:youtu\.be\/|youtube\.com(?:\/embed\/|\/v\/|\/watch\?v=|\/user\/\S+|\/ytscreeningroom\?v=))([\w\-]{10,12})\b/)[1];
            document.getElementById('modal-video-title').innerText = title;
            document.getElementById('video-modal').classList.remove('hidden');
            maxWatchedTime = 0; window.videoCompletedFlag = false;
            if(player && player.loadVideoById) { player.loadVideoById(id); player.unMute(); }
            else setTimeout(() => { if(player) player.loadVideoById(id); }, 1000);
        };
        window.closeVideoModal = () => {
            document.getElementById('video-modal').classList.add('hidden');
            if(player) player.stopVideo();
            stopVideoTracking();
        };
        window.togglePlayPause = () => {
            if(player.getPlayerState() == 1) player.pauseVideo(); else player.playVideo();
        };
        window.unmuteVideo = () => { player.unMute(); document.getElementById('mute-warning').classList.add('hidden'); };
        window.toggleFullscreen = () => {
            const el = document.getElementById('fullscreen-container');
            if(!document.fullscreenElement) el.requestFullscreen(); else document.exitFullscreen();
        }

        // --- EXAM (THI ONLINE) ---
        window.openExamModal = (url, title) => {
            document.getElementById('exam-modal-title').innerText = title;
            document.getElementById('exam-iframe').src = url;
            document.getElementById('exam-loading').style.display = 'flex';
            document.getElementById('exam-modal').classList.remove('hidden');
        };
        window.closeExamModal = () => {
            if(confirm("Bạn có chắc muốn kết thúc bài thi?")) {
                document.getElementById('exam-modal').classList.add('hidden');
                document.getElementById('exam-iframe').src = "";
            }
        };

        // --- DATA & LOGIC ---
        function loadProgress() {
            if (!userData) return;
            ['toan', 'ly', 'hoa'].forEach(s => {
                const v = userData.progress[s] || 0;
                document.getElementById(`progress-${s}`).style.width = `${v}%`;
                document.getElementById(`text-progress-${s}`).innerText = `${v}%`;
            });
        }

        async function updateSubjectProgress(amount) {
            const subj = currentSubject;
            const newP = Math.min((userData.progress[subj] || 0) + amount, 100);
            userData.progress[subj] = newP;
            
            // Cập nhật cả private profile VÀ public directory (cho Admin xem)
            await updateDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profile', 'info'), { [`progress.${subj}`]: newP });
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users_directory', currentUser.uid), { [`progress.${subj}`]: newP });
            loadProgress();
        }

        let currentSubject = '';
        function loadSubject(subject) {
            currentSubject = subject;
            const data = {
                toan: {
                    videos: [
                        {title: "Hàm số Lũy thừa", url: "https://www.youtube.com/watch?v=S3O8i_Q0dO8", author: "Thầy A"},
                        {title: "Khảo sát hàm số", url: "https://www.youtube.com/watch?v=D-yVqX-iW4U", author: "Thầy B"}
                    ],
                    exams: [
                        {title: "Đề thi thử Toán 2026 (Online)", url: "https://taodethi.xyz/exam/demo-math", source: "TaoDeThi.xyz"}
                    ]
                },
                ly: { videos: [], exams: [] },
                hoa: { videos: [], exams: [] }
            }[subject];

            const container = document.getElementById('subject-content-list');
            container.innerHTML = '';

            // Render Videos
            if(data.videos.length > 0) {
                container.innerHTML += `<h3 class="font-bold text-lg mb-2 text-blue-700">Bài Giảng Video</h3>`;
                data.videos.forEach((v, i) => {
                    container.innerHTML += `
                        <div class="flex justify-between items-center p-3 border rounded mb-2 hover:bg-gray-50">
                            <div onclick="openVideoModal('${v.url}', '${v.title}')" class="cursor-pointer flex items-center">
                                <i class="fas fa-play-circle text-blue-500 text-2xl mr-3"></i>
                                <div><div class="font-bold">Bài ${i+1}: ${v.title}</div><div class="text-xs text-gray-500">${v.author}</div></div>
                            </div>
                            <button onclick="openVideoModal('${v.url}', '${v.title}')" class="bg-blue-600 text-white px-3 py-1 rounded text-sm">Học Ngay</button>
                        </div>`;
                });
            }

            // Render Exams
            if(data.exams.length > 0) {
                container.innerHTML += `<h3 class="font-bold text-lg mt-6 mb-2 text-red-700">Thi Trực Tuyến</h3>`;
                data.exams.forEach(e => {
                    container.innerHTML += `
                        <div class="flex justify-between items-center p-3 border border-red-200 bg-red-50 rounded mb-2">
                            <div class="flex items-center">
                                <i class="fas fa-file-signature text-red-500 text-2xl mr-3"></i>
                                <div><div class="font-bold">${e.title}</div><div class="text-xs text-gray-500">${e.source}</div></div>
                            </div>
                            <button onclick="openExamModal('${e.url}', '${e.title}')" class="bg-red-600 text-white px-3 py-1 rounded text-sm">Làm Bài Ngay</button>
                        </div>`;
                });
            }
        }

        // --- ADMIN & CHAT ---
        // Chat Logic
        let chatUnsubscribe;
        function loadChat() {
            const chatBox = document.getElementById('chat-box');
            chatUnsubscribe = onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'group_chat'), orderBy('createdAt', 'asc')), s => {
                chatBox.innerHTML = '';
                s.forEach(d => {
                    const m = d.data();
                    const isMe = m.uid === currentUser.uid;
                    chatBox.innerHTML += `<div class="flex ${isMe ? 'justify-end' : 'justify-start'}"><div class="rounded p-2 text-sm max-w-[70%] ${isMe ? 'bg-blue-500 text-white' : 'bg-gray-200'}"><strong>${m.email.split('@')[0]}</strong>: ${m.text}</div></div>`;
                });
                chatBox.scrollTop = chatBox.scrollHeight;
            });
        }
        window.sendChat = async () => {
            const txt = document.getElementById('chat-input').value;
            if(!txt) return;
            if(userData.isBlocked) { alert("Bạn bị khóa chat!"); return; }
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'group_chat'), { text: txt, uid: currentUser.uid, email: currentUser.email, createdAt: serverTimestamp() });
            document.getElementById('chat-input').value = '';
        }

        // Admin Logic
        window.loadUserList = async () => {
            if(userData.role !== 'admin') return;
            const tbody = document.getElementById('user-list-body');
            tbody.innerHTML = '<tr><td colspan="6" class="text-center p-4">Loading...</td></tr>';
            const s = await getDocs(query(collection(db, 'artifacts', appId, 'public', 'data', 'users_directory')));
            tbody.innerHTML = '';
            s.forEach(d => {
                const u = d.data();
                const p = u.progress || {toan:0, ly:0, hoa:0};
                tbody.innerHTML += `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="p-3 font-bold text-blue-900">${u.email}</td>
                        <td class="p-3 text-center bg-blue-50">${p.toan}%</td>
                        <td class="p-3 text-center bg-purple-50">${p.ly}%</td>
                        <td class="p-3 text-center bg-green-50">${p.hoa}%</td>
                        <td class="p-3"><span class="px-2 py-1 rounded text-xs ${u.isBlocked ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'}">${u.isBlocked ? 'Bị Khóa' : 'Hoạt Động'}</span></td>
                        <td class="p-3">
                            ${u.role !== 'admin' ? `<button onclick="toggleBlock('${d.id}', ${!u.isBlocked})" class="border border-red-500 text-red-500 px-2 py-1 text-xs rounded hover:bg-red-50">${u.isBlocked ? 'Mở Khóa' : 'Khóa Ngay'}</button>` : ''}
                        </td>
                    </tr>`;
            });
        }
        window.toggleBlock = async (uid, status) => {
            if(!confirm("Hành động này sẽ Kick user ra khỏi hệ thống ngay lập tức. Tiếp tục?")) return;
            // Update cả private profile (để login check) và public directory (để hiển thị list)
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users_directory', uid), { isBlocked: status });
            try { await updateDoc(doc(db, 'artifacts', appId, 'users', uid, 'profile', 'info'), { isBlocked: status }); } catch(e){}
            loadUserList();
        }

        function showToast(msg, type) {
            const t = document.createElement('div');
            t.className = `p-3 rounded text-white shadow mb-2 fade-in ${type==='error'?'bg-red-500':'bg-green-500'}`;
            t.innerText = msg;
            document.getElementById('toast-container').appendChild(t);
            setTimeout(()=>t.remove(), 3000);
        }
    </script>
</body>
</html>
